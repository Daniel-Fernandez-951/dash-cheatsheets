
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>client_session – Logical sessions for sequential operations — PyMongo 3.11.0 documentation</title>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pydoctheme.css" rel="stylesheet" type="text/css"/>
<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
<script src="../../_static/jquery.js"></script>
<script src="../../_static/underscore.js"></script>
<script src="../../_static/doctools.js"></script>
<script src="../../_static/language_data.js"></script>
<script src="../../_static/delighted.js"></script>
<script src="../../_static/sidebar.js"></script>
<link href="../../genindex.html" rel="index" title="Index"/>
<link href="../../search.html" rel="search" title="Search"/>
<link href="collation.html" rel="next" title="collation – Tools for working with collations."/>
<link href="change_stream.html" rel="prev" title="change_stream – Watch changes on a collection, database, or cluster"/>
</head><body>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a accesskey="I" href="../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="right">
<a accesskey="N" href="collation.html" title="collation – Tools for working with collations.">next</a> |</li>
<li class="right">
<a accesskey="P" href="change_stream.html" title="change_stream – Watch changes on a collection, database, or cluster">previous</a> |</li>
<li class="nav-item nav-item-0"><a href="../../index.html">PyMongo 3.11.0 documentation</a> »</li>
<li class="nav-item nav-item-1"><a href="../index.html">API Documentation</a> »</li>
<li class="nav-item nav-item-2"><a accesskey="U" href="index.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pymongo</span></code> – Python driver for MongoDB</a> »</li>
<li class="nav-item nav-item-this"><a href=""><code class="xref py py-mod docutils literal notranslate"><span class="pre">client_session</span></code> – Logical sessions for sequential operations</a></li>
</ul>
</div>
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="section" id="module-pymongo.client_session">
<span id="client-session-logical-sessions-for-sequential-operations"></span><h1><a name="//apple_ref/cpp/Module/pymongo.client_session"></a><code class="xref py py-mod docutils literal notranslate"><span class="pre">client_session</span></code> – Logical sessions for sequential operations<a class="headerlink" href="#module-pymongo.client_session" title="Permalink to this headline">¶</a></h1>
<p>Logical sessions for ordering sequential operations.</p>
<p>Requires MongoDB 3.6.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.6.</span></p>
</div>
<div class="section" id="causally-consistent-reads">
<h2>Causally Consistent Reads<a class="headerlink" href="#causally-consistent-reads" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">(</span><span class="n">causal_consistency</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">collection</span>
    <span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s1">'_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">'$set'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'x'</span><span class="p">:</span> <span class="mi">10</span><span class="p">}},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="n">secondary_c</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span>
        <span class="n">read_preference</span><span class="o">=</span><span class="n">ReadPreference</span><span class="o">.</span><span class="n">SECONDARY</span><span class="p">)</span>

    <span class="c1"># A secondary read waits for replication of the write.</span>
    <span class="n">secondary_c</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">'_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
<p>If <cite>causal_consistency</cite> is True (the default), read operations that use
the session are causally after previous read and write operations. Using a
causally consistent session, an application can read its own writes and is
guaranteed monotonic reads, even when reading from replica set secondaries.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p class="admonition-title">The MongoDB documentation on</p>
<p><a class="reference external" href="http://dochub.mongodb.org/core/causal-consistency" name="pymongo.client_session.ClientSession"><em>causal-consistency</em></a></p>
</div>
</div>
<div class="section" id="transactions">
<span id="transactions-ref"></span><h2>Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h2>
<p>MongoDB 4.0 adds support for transactions on replica set primaries. A
transaction is associated with a <a class="reference internal" href="#pymongo.client_session.ClientSession" title="pymongo.client_session.ClientSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClientSession</span></code></a>. To start a transaction
on a session, use <a class="reference internal" href="#pymongo.client_session.ClientSession.start_transaction" title="pymongo.client_session.ClientSession.start_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ClientSession.start_transaction()</span></code></a> in a with-statement.
Then, execute an operation within the transaction by passing the session to the
operation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">orders</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">orders</span>
<span class="n">inventory</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">inventory</span>
<span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">start_transaction</span><span class="p">():</span>
        <span class="n">orders</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">"sku"</span><span class="p">:</span> <span class="s2">"abc123"</span><span class="p">,</span> <span class="s2">"qty"</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="n">inventory</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">"sku"</span><span class="p">:</span> <span class="s2">"abc123"</span><span class="p">,</span> <span class="s2">"qty"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"$gte"</span><span class="p">:</span> <span class="mi">100</span><span class="p">}},</span>
                             <span class="p">{</span><span class="s2">"$inc"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"qty"</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">}},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
<p>Upon normal completion of <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">session.start_transaction()</span></code> block, the
transaction automatically calls <a class="reference internal" href="#pymongo.client_session.ClientSession.commit_transaction" title="pymongo.client_session.ClientSession.commit_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ClientSession.commit_transaction()</span></code></a>.
If the block exits with an exception, the transaction automatically calls
<a class="reference internal" href="#pymongo.client_session.ClientSession.abort_transaction" title="pymongo.client_session.ClientSession.abort_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ClientSession.abort_transaction()</span></code></a>.</p>
<p>In general, multi-document transactions only support read/write (CRUD)
operations on existing collections. However, MongoDB 4.4 adds support for
creating collections and indexes with some limitations, including an
insert operation that would result in the creation of a new collection.
For a complete description of all the supported and unsupported operations
see the <a class="reference external" href="http://dochub.mongodb.org/core/transactions">MongoDB server’s documentation for transactions</a>.</p>
<p>A session may only have a single active transaction at a time, multiple
transactions on the same session can be executed in sequence.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.7.</span></p>
</div>
<div class="section" id="sharded-transactions">
<h3>Sharded Transactions<a class="headerlink" href="#sharded-transactions" title="Permalink to this headline">¶</a></h3>
<p>PyMongo 3.9 adds support for transactions on sharded clusters running MongoDB
4.2. Sharded transactions have the same API as replica set transactions.
When running a transaction against a sharded cluster, the session is
pinned to the mongos server selected for the first operation in the
transaction. All subsequent operations that are part of the same transaction
are routed to the same mongos server. When the transaction is completed, by
running either commitTransaction or abortTransaction, the session is unpinned.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.9.</span></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p class="admonition-title">The MongoDB documentation on</p>
<p><a class="reference external" href="http://dochub.mongodb.org/core/transactions" name="sharded-transactions"><em>transactions</em></a></p>
</div>
</div>
</div>
<div class="section" id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="pymongo.client_session.ClientSession"><a name="//apple_ref/cpp/Class/pymongo.client_session.ClientSession"></a>
<em class="property">class </em><code class="sig-prename descclassname">pymongo.client_session.</code><code class="sig-name descname">ClientSession</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">client</span></em>, <em class="sig-param"><span class="n">server_session</span></em>, <em class="sig-param"><span class="n">options</span></em>, <em class="sig-param"><span class="n">authset</span></em>, <em class="sig-param"><span class="n">implicit</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession" title="Permalink to this definition">¶</a></dt>
<dd><p>A session for ordering sequential operations.</p>
<p><a class="reference internal" href="#pymongo.client_session.ClientSession" title="pymongo.client_session.ClientSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClientSession</span></code></a> instances are <strong>not thread-safe or fork-safe</strong>.
They can only be used by one thread or process at a time. A single
<a class="reference internal" href="#pymongo.client_session.ClientSession" title="pymongo.client_session.ClientSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClientSession</span></code></a> cannot be used to run multiple operations
concurrently.</p>
<p>Should not be initialized directly by application developers - to create a
<a class="reference internal" href="#pymongo.client_session.ClientSession" title="pymongo.client_session.ClientSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClientSession</span></code></a>, call
<a class="reference internal" href="mongo_client.html#pymongo.mongo_client.MongoClient.start_session" title="pymongo.mongo_client.MongoClient.start_session"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_session()</span></code></a>.</p>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.abort_transaction"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.abort_transaction"></a>
<code class="sig-name descname">abort_transaction</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.abort_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>Abort a multi-statement transaction.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.7.</span></p>
</div>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.advance_cluster_time"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.advance_cluster_time"></a>
<code class="sig-name descname">advance_cluster_time</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cluster_time</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.advance_cluster_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Update the cluster time for this session.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><cite>cluster_time</cite>: The
<a class="reference internal" href="#pymongo.client_session.ClientSession.cluster_time" title="pymongo.client_session.ClientSession.cluster_time"><code class="xref py py-data docutils literal notranslate"><span class="pre">cluster_time</span></code></a> from
another <cite>ClientSession</cite> instance.</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.advance_operation_time"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.advance_operation_time"></a>
<code class="sig-name descname">advance_operation_time</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">operation_time</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.advance_operation_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Update the operation time for this session.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><cite>operation_time</cite>: The
<a class="reference internal" href="#pymongo.client_session.ClientSession.operation_time" title="pymongo.client_session.ClientSession.operation_time"><code class="xref py py-data docutils literal notranslate"><span class="pre">operation_time</span></code></a> from
another <cite>ClientSession</cite> instance.</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.client"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.client"></a>
<em class="property">property </em><code class="sig-name descname">client</code><a class="headerlink" href="#pymongo.client_session.ClientSession.client" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="mongo_client.html#pymongo.mongo_client.MongoClient" title="pymongo.mongo_client.MongoClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">MongoClient</span></code></a> this session was
created from.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.cluster_time"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.cluster_time"></a>
<em class="property">property </em><code class="sig-name descname">cluster_time</code><a class="headerlink" href="#pymongo.client_session.ClientSession.cluster_time" title="Permalink to this definition">¶</a></dt>
<dd><p>The cluster time returned by the last operation executed
in this session.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.commit_transaction"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.commit_transaction"></a>
<code class="sig-name descname">commit_transaction</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.commit_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>Commit a multi-statement transaction.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.7.</span></p>
</div>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.end_session"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.end_session"></a>
<code class="sig-name descname">end_session</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.end_session" title="Permalink to this definition">¶</a></dt>
<dd><p>Finish this session. If a transaction has started, abort it.</p>
<p>It is an error to use the session after the session has ended.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.has_ended"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.has_ended"></a>
<em class="property">property </em><code class="sig-name descname">has_ended</code><a class="headerlink" href="#pymongo.client_session.ClientSession.has_ended" title="Permalink to this definition">¶</a></dt>
<dd><p>True if this session is finished.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.in_transaction"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.in_transaction"></a>
<em class="property">property </em><code class="sig-name descname">in_transaction</code><a class="headerlink" href="#pymongo.client_session.ClientSession.in_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>True if this session has an active multi-statement transaction.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.10.</span></p>
</div>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.operation_time"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.operation_time"></a>
<em class="property">property </em><code class="sig-name descname">operation_time</code><a class="headerlink" href="#pymongo.client_session.ClientSession.operation_time" title="Permalink to this definition">¶</a></dt>
<dd><p>The operation time returned by the last operation executed
in this session.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.options"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.options"></a>
<em class="property">property </em><code class="sig-name descname">options</code><a class="headerlink" href="#pymongo.client_session.ClientSession.options" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#pymongo.client_session.SessionOptions" title="pymongo.client_session.SessionOptions"><code class="xref py py-class docutils literal notranslate"><span class="pre">SessionOptions</span></code></a> this session was created with.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.session_id"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.session_id"></a>
<em class="property">property </em><code class="sig-name descname">session_id</code><a class="headerlink" href="#pymongo.client_session.ClientSession.session_id" title="Permalink to this definition">¶</a></dt>
<dd><p>A BSON document, the opaque server session identifier.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.start_transaction"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.start_transaction"></a>
<code class="sig-name descname">start_transaction</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">read_concern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">write_concern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">read_preference</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">max_commit_time_ms</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.start_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>Start a multi-statement transaction.</p>
<p>Takes the same arguments as <a class="reference internal" href="#pymongo.client_session.TransactionOptions" title="pymongo.client_session.TransactionOptions"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransactionOptions</span></code></a>.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 3.9: </span>Added the <code class="docutils literal notranslate"><span class="pre">max_commit_time_ms</span></code> option.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.7.</span></p>
</div>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.ClientSession.with_transaction"><a name="//apple_ref/cpp/Method/pymongo.client_session.ClientSession.with_transaction"></a>
<code class="sig-name descname">with_transaction</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">callback</span></em>, <em class="sig-param"><span class="n">read_concern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">write_concern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">read_preference</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">max_commit_time_ms</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.ClientSession.with_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>Execute a callback in a transaction.</p>
<p>This method starts a transaction on this session, executes <code class="docutils literal notranslate"><span class="pre">callback</span></code>
once, and then commits the transaction. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">orders</span>
    <span class="n">inventory</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">inventory</span>
    <span class="n">orders</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">"sku"</span><span class="p">:</span> <span class="s2">"abc123"</span><span class="p">,</span> <span class="s2">"qty"</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="n">inventory</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">"sku"</span><span class="p">:</span> <span class="s2">"abc123"</span><span class="p">,</span> <span class="s2">"qty"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"$gte"</span><span class="p">:</span> <span class="mi">100</span><span class="p">}},</span>
                         <span class="p">{</span><span class="s2">"$inc"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"qty"</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">}},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

<span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</pre></div>
</div>
<p>To pass arbitrary arguments to the <code class="docutils literal notranslate"><span class="pre">callback</span></code>, wrap your callable
with a <code class="docutils literal notranslate"><span class="pre">lambda</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">custom_arg</span><span class="p">,</span> <span class="n">custom_kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Transaction operations...</span>

<span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">"custom_arg"</span><span class="p">,</span> <span class="n">custom_kwarg</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>In the event of an exception, <code class="docutils literal notranslate"><span class="pre">with_transaction</span></code> may retry the commit
or the entire transaction, therefore <code class="docutils literal notranslate"><span class="pre">callback</span></code> may be invoked
multiple times by a single call to <code class="docutils literal notranslate"><span class="pre">with_transaction</span></code>. Developers
should be mindful of this possiblity when writing a <code class="docutils literal notranslate"><span class="pre">callback</span></code> that
modifies application state or has any other side-effects.
Note that even when the <code class="docutils literal notranslate"><span class="pre">callback</span></code> is invoked multiple times,
<code class="docutils literal notranslate"><span class="pre">with_transaction</span></code> ensures that the transaction will be committed
at-most-once on the server.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">callback</span></code> should not attempt to start new transactions, but
should simply run operations meant to be contained within a
transaction. The <code class="docutils literal notranslate"><span class="pre">callback</span></code> should also not commit the transaction;
this is handled automatically by <code class="docutils literal notranslate"><span class="pre">with_transaction</span></code>. If the
<code class="docutils literal notranslate"><span class="pre">callback</span></code> does commit or abort the transaction without error,
however, <code class="docutils literal notranslate"><span class="pre">with_transaction</span></code> will return without taking further
action.</p>
<p><a class="reference internal" href="#pymongo.client_session.ClientSession" title="pymongo.client_session.ClientSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClientSession</span></code></a> instances are <strong>not thread-safe or fork-safe</strong>.
Consequently, the <code class="docutils literal notranslate"><span class="pre">callback</span></code> must not attempt to execute multiple
operations concurrently.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">callback</span></code> raises an exception, <code class="docutils literal notranslate"><span class="pre">with_transaction</span></code>
automatically aborts the current transaction. When <code class="docutils literal notranslate"><span class="pre">callback</span></code> or
<a class="reference internal" href="#pymongo.client_session.ClientSession.commit_transaction" title="pymongo.client_session.ClientSession.commit_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">commit_transaction()</span></code></a> raises an exception that
includes the <code class="docutils literal notranslate"><span class="pre">"TransientTransactionError"</span></code> error label,
<code class="docutils literal notranslate"><span class="pre">with_transaction</span></code> starts a new transaction and re-executes
the <code class="docutils literal notranslate"><span class="pre">callback</span></code>.</p>
<p>When <a class="reference internal" href="#pymongo.client_session.ClientSession.commit_transaction" title="pymongo.client_session.ClientSession.commit_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">commit_transaction()</span></code></a> raises an exception with
the <code class="docutils literal notranslate"><span class="pre">"UnknownTransactionCommitResult"</span></code> error label,
<code class="docutils literal notranslate"><span class="pre">with_transaction</span></code> retries the commit until the result of the
transaction is known.</p>
<p>This method will cease retrying after 120 seconds has elapsed. This
timeout is not configurable and any exception raised by the
<code class="docutils literal notranslate"><span class="pre">callback</span></code> or by <a class="reference internal" href="#pymongo.client_session.ClientSession.commit_transaction" title="pymongo.client_session.ClientSession.commit_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ClientSession.commit_transaction()</span></code></a> after the
timeout is reached will be re-raised. Applications that desire a
different timeout duration should not use this method.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><cite>callback</cite>: The callable <code class="docutils literal notranslate"><span class="pre">callback</span></code> to run inside a transaction.
The callable must accept a single argument, this session. Note,
under certain error conditions the callback may be run multiple
times.</p></li>
<li><p><cite>read_concern</cite> (optional): The
<a class="reference internal" href="read_concern.html#pymongo.read_concern.ReadConcern" title="pymongo.read_concern.ReadConcern"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReadConcern</span></code></a> to use for this
transaction.</p></li>
<li><p><cite>write_concern</cite> (optional): The
<a class="reference internal" href="write_concern.html#pymongo.write_concern.WriteConcern" title="pymongo.write_concern.WriteConcern"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteConcern</span></code></a> to use for this
transaction.</p></li>
<li><p><cite>read_preference</cite> (optional): The read preference to use for this
transaction. If <code class="docutils literal notranslate"><span class="pre">None</span></code> (the default) the <code class="xref py py-attr docutils literal notranslate"><span class="pre">read_preference</span></code>
of this <code class="xref py py-class docutils literal notranslate"><span class="pre">Database</span></code> is used. See
<a class="reference internal" href="read_preferences.html#module-pymongo.read_preferences" title="pymongo.read_preferences: Utilities for choosing which member of a replica set to read from."><code class="xref py py-mod docutils literal notranslate"><span class="pre">read_preferences</span></code></a> for options.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The return value of the <code class="docutils literal notranslate"><span class="pre">callback</span></code>.</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.9.</span></p>
</div>
</dd></dl>
</dd></dl>
<dl class="py class">
<dt id="pymongo.client_session.SessionOptions"><a name="//apple_ref/cpp/Class/pymongo.client_session.SessionOptions"></a>
<em class="property">class </em><code class="sig-prename descclassname">pymongo.client_session.</code><code class="sig-name descname">SessionOptions</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">causal_consistency</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">default_transaction_options</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.SessionOptions" title="Permalink to this definition">¶</a></dt>
<dd><p>Options for a new <a class="reference internal" href="#pymongo.client_session.ClientSession" title="pymongo.client_session.ClientSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClientSession</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><cite>causal_consistency</cite> (optional): If True (the default), read
operations are causally ordered within the session.</p></li>
<li><p><cite>default_transaction_options</cite> (optional): The default
TransactionOptions to use for transactions started on this session.</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt id="pymongo.client_session.SessionOptions.causal_consistency"><a name="//apple_ref/cpp/Method/pymongo.client_session.SessionOptions.causal_consistency"></a>
<em class="property">property </em><code class="sig-name descname">causal_consistency</code><a class="headerlink" href="#pymongo.client_session.SessionOptions.causal_consistency" title="Permalink to this definition">¶</a></dt>
<dd><p>Whether causal consistency is configured.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.SessionOptions.default_transaction_options"><a name="//apple_ref/cpp/Method/pymongo.client_session.SessionOptions.default_transaction_options"></a>
<em class="property">property </em><code class="sig-name descname">default_transaction_options</code><a class="headerlink" href="#pymongo.client_session.SessionOptions.default_transaction_options" title="Permalink to this definition">¶</a></dt>
<dd><p>The default TransactionOptions to use for transactions started on
this session.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.7.</span></p>
</div>
</dd></dl>
</dd></dl>
<dl class="py class">
<dt id="pymongo.client_session.TransactionOptions"><a name="//apple_ref/cpp/Class/pymongo.client_session.TransactionOptions"></a>
<em class="property">class </em><code class="sig-prename descclassname">pymongo.client_session.</code><code class="sig-name descname">TransactionOptions</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">read_concern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">write_concern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">read_preference</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">max_commit_time_ms</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#pymongo.client_session.TransactionOptions" title="Permalink to this definition">¶</a></dt>
<dd><p>Options for <a class="reference internal" href="#pymongo.client_session.ClientSession.start_transaction" title="pymongo.client_session.ClientSession.start_transaction"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ClientSession.start_transaction()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><cite>read_concern</cite> (optional): The
<a class="reference internal" href="read_concern.html#pymongo.read_concern.ReadConcern" title="pymongo.read_concern.ReadConcern"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReadConcern</span></code></a> to use for this transaction.
If <code class="docutils literal notranslate"><span class="pre">None</span></code> (the default) the <a class="reference internal" href="#pymongo.client_session.TransactionOptions.read_preference" title="pymongo.client_session.TransactionOptions.read_preference"><code class="xref py py-attr docutils literal notranslate"><span class="pre">read_preference</span></code></a> of
the <code class="xref py py-class docutils literal notranslate"><span class="pre">MongoClient</span></code> is used.</p></li>
<li><p><cite>write_concern</cite> (optional): The
<a class="reference internal" href="write_concern.html#pymongo.write_concern.WriteConcern" title="pymongo.write_concern.WriteConcern"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteConcern</span></code></a> to use for this
transaction. If <code class="docutils literal notranslate"><span class="pre">None</span></code> (the default) the <a class="reference internal" href="#pymongo.client_session.TransactionOptions.read_preference" title="pymongo.client_session.TransactionOptions.read_preference"><code class="xref py py-attr docutils literal notranslate"><span class="pre">read_preference</span></code></a> of
the <code class="xref py py-class docutils literal notranslate"><span class="pre">MongoClient</span></code> is used.</p></li>
<li><p><cite>read_preference</cite> (optional): The read preference to use. If
<code class="docutils literal notranslate"><span class="pre">None</span></code> (the default) the <a class="reference internal" href="#pymongo.client_session.TransactionOptions.read_preference" title="pymongo.client_session.TransactionOptions.read_preference"><code class="xref py py-attr docutils literal notranslate"><span class="pre">read_preference</span></code></a> of this
<code class="xref py py-class docutils literal notranslate"><span class="pre">MongoClient</span></code> is used. See <a class="reference internal" href="read_preferences.html#module-pymongo.read_preferences" title="pymongo.read_preferences: Utilities for choosing which member of a replica set to read from."><code class="xref py py-mod docutils literal notranslate"><span class="pre">read_preferences</span></code></a>
for options. Transactions which read must use
<a class="reference internal" href="read_preferences.html#pymongo.read_preferences.ReadPreference.PRIMARY" title="pymongo.read_preferences.ReadPreference.PRIMARY"><code class="xref py py-attr docutils literal notranslate"><span class="pre">PRIMARY</span></code></a>.</p></li>
<li><p><cite>max_commit_time_ms</cite> (optional): The maximum amount of time to allow a
single commitTransaction command to run. This option is an alias for
maxTimeMS option on the commitTransaction command. If <code class="docutils literal notranslate"><span class="pre">None</span></code> (the
default) maxTimeMS is not used.</p></li>
</ul>
</dd>
</dl>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 3.9: </span>Added the <code class="docutils literal notranslate"><span class="pre">max_commit_time_ms</span></code> option.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.7.</span></p>
</div>
<dl class="py method">
<dt id="pymongo.client_session.TransactionOptions.max_commit_time_ms"><a name="//apple_ref/cpp/Method/pymongo.client_session.TransactionOptions.max_commit_time_ms"></a>
<em class="property">property </em><code class="sig-name descname">max_commit_time_ms</code><a class="headerlink" href="#pymongo.client_session.TransactionOptions.max_commit_time_ms" title="Permalink to this definition">¶</a></dt>
<dd><p>The maxTimeMS to use when running a commitTransaction command.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.9.</span></p>
</div>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.TransactionOptions.read_concern"><a name="//apple_ref/cpp/Method/pymongo.client_session.TransactionOptions.read_concern"></a>
<em class="property">property </em><code class="sig-name descname">read_concern</code><a class="headerlink" href="#pymongo.client_session.TransactionOptions.read_concern" title="Permalink to this definition">¶</a></dt>
<dd><p>This transaction’s <a class="reference internal" href="read_concern.html#pymongo.read_concern.ReadConcern" title="pymongo.read_concern.ReadConcern"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReadConcern</span></code></a>.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.TransactionOptions.read_preference"><a name="//apple_ref/cpp/Method/pymongo.client_session.TransactionOptions.read_preference"></a>
<em class="property">property </em><code class="sig-name descname">read_preference</code><a class="headerlink" href="#pymongo.client_session.TransactionOptions.read_preference" title="Permalink to this definition">¶</a></dt>
<dd><p>This transaction’s <a class="reference internal" href="read_preferences.html#pymongo.read_preferences.ReadPreference" title="pymongo.read_preferences.ReadPreference"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReadPreference</span></code></a>.</p>
</dd></dl>
<dl class="py method">
<dt id="pymongo.client_session.TransactionOptions.write_concern"><a name="//apple_ref/cpp/Method/pymongo.client_session.TransactionOptions.write_concern"></a>
<em class="property">property </em><code class="sig-name descname">write_concern</code><a class="headerlink" href="#pymongo.client_session.TransactionOptions.write_concern" title="Permalink to this definition">¶</a></dt>
<dd><p>This transaction’s <a class="reference internal" href="write_concern.html#pymongo.write_concern.WriteConcern" title="pymongo.write_concern.WriteConcern"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteConcern</span></code></a>.</p>
</dd></dl>
</dd></dl>
</div>
</div>
<div class="clearer"></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li><a class="reference internal" href="#"><code class="xref py py-mod docutils literal notranslate"><span class="pre">client_session</span></code> – Logical sessions for sequential operations</a><ul>
<li><a class="reference internal" href="#causally-consistent-reads">Causally Consistent Reads</a></li>
<li><a class="reference internal" href="#transactions">Transactions</a><ul>
<li><a class="reference internal" href="#sharded-transactions">Sharded Transactions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#classes">Classes</a></li>
</ul>
</li>
</ul>
<h4>Previous topic</h4>
<p class="topless"><a href="change_stream.html" title="previous chapter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">change_stream</span></code> – Watch changes on a collection, database, or cluster</a></p>
<h4>Next topic</h4>
<p class="topless"><a href="collation.html" title="next chapter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">collation</span></code> – Tools for working with collations.</a></p>
<div aria-label="source link" role="note">
<h3>This Page</h3>
<ul class="this-page-menu">
<li><a href="../../_sources/api/pymongo/client_session.rst.txt" rel="nofollow">Show Source</a></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script>$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a href="../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="right">
<a href="collation.html" title="collation – Tools for working with collations.">next</a> |</li>
<li class="right">
<a href="change_stream.html" title="change_stream – Watch changes on a collection, database, or cluster">previous</a> |</li>
<li class="nav-item nav-item-0"><a href="../../index.html">PyMongo 3.11.0 documentation</a> »</li>
<li class="nav-item nav-item-1"><a href="../index.html">API Documentation</a> »</li>
<li class="nav-item nav-item-2"><a href="index.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pymongo</span></code> – Python driver for MongoDB</a> »</li>
<li class="nav-item nav-item-this"><a href=""><code class="xref py py-mod docutils literal notranslate"><span class="pre">client_session</span></code> – Logical sessions for sequential operations</a></li>
</ul>
</div>
<div class="footer" role="contentinfo">
        © Copyright MongoDB, Inc. 2008-present. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.
    </div>
</body>
</html>